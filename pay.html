<!--
 * @Author: sunjiankun
 * @LastEditors: sunjiankun
 * @LastEditTime: 2020-02-28 13:19:09
 -->
<!DOCTYPE html>
<html lang="zh-cmn-Hans">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta name="description" content="helloworld" />
		<meta
			name="viewport"
			content="user-scalable=0, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height"
		/>
		<meta name="theme-color" content="#000000" />
    <meta name="format-detection" content="telephone=no" />
    <title>支付界面</title>
		<link type="favicon" rel="shortcut icon" href="./favicon.ico" />
		<!-- <script src="/assets/lib/vconsole.min.js"></script> -->
		<script src="/assets/lib/flexible_css.js"></script>
    <script src="/assets/lib/flexible.min.js"></script>
    <script src="/assets/lib/jquery.min.js"></script>
		<style>
      /* stylelint-disable */
      .QRPay_box {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #868E9E;
        font-size: 0.36rem;
        line-height: 0.7rem;
      }
      .err_img {
        width: 100%;
      }
      .reloadBtn {
        color: #ebde74;
      }
      .dot {
        font-size: 0.5rem;
        display: inline-block;
        width: 0;
        vertical-align: bottom;
        overflow: hidden;
        animation: dot 2s infinite step-start;
        letter-spacing: 0.05rem;
      }
      @keyframes dot {
        0% { width: 0; margin-right: 1em; }
        33% { width: 0.3em; margin-right: 0.7em; }
        66% { width: 0.6em; margin-right: 0.4em; }
        100% { width: 1em; margin-right: 0;}
      }
		</style>
	</head>

	<body ontouchstart>
		<div id="root">
			<div class="QRPay_box" id="QRPay">
          正在启动微信支付
					<br />
          请您耐心等待<span class="dot">...</span>
			</div>
      <script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
      <script>
        // 获取url参数
        function getUrlParam(name){
          var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
          var r = window.location.search.substr(1).match(reg);  //匹配目标参数
          if (r!=null) return unescape(r[2]); return null; //返回参数值
        }
        // 获取机型
        function getDeviceType(){
          const u = navigator.userAgent;
          const osType =
            u.indexOf('Android') > -1 || u.indexOf('Adr') > -1
              ? 'ANDROID'
              : u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)
              ? 'IOS'
              : 'PC';
          return osType;
        };
        // 设置cookie
        function setCookie(cname, cvalue, exdays){
          var d = new Date();
          d.setTime(d.getTime()+(exdays*24*60*60*1000));
          var expires = "expires="+d.toGMTString();
          document.cookie = cname + "=" + cvalue + "; " + expires;
        }
        // 获取cookie
        function getCookie(cname) {
          var name = cname + "=";
          var decodedCookie = decodeURIComponent(document.cookie);
          var ca = decodedCookie.split(';');
          for(var i = 0; i <ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
              c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
              return c.substring(name.length, c.length);
            }
          }
          return "";
        }
        // 页面加载完成
        $(function(){
          // 物理返回
          window.history.pushState(null, null, document.URL);
          if (window.history && window.history.pushState) {
            window.addEventListener(
              'popstate',
              () => {
                window.close();
                window.WeixinJSBridge.call('closeWindow');
              },
              false
            )
          }
          silentAuth();
        })
        // 静默授权
        function silentAuth() {
          if (getUrlParam('code')) {
            wxAuth();
          } else {
            wxCheckAuth();
          }
        }

        // 微信授权
        function wxAuth(){
          const osName = getDeviceType() === 'IOS' ? '01' : getDeviceType() === 'ANDROID' ? '02' : '';
          $.ajax({
              type: "POST",
              url: "/front/signup/wx/authcb",
              data: JSON.stringify({
                state: getUrlParam('state'),
                code: getUrlParam('code'),
                // channelCode: getH5Channel(),
                osType: getDeviceType().toLowerCase(),
                loginType: '0',
                imei: '',
                location: '-1,-1',
                mac: '',
                // wxToken: Cookie.get('FIN-HD-WECHAT-TOKEN'),
                redirectUrl: '',
                registrationId: '',
                userChannel: 'others'
              }),
             contentType: "application/json",
             beforeSend: function (XMLHttpRequest) {
               XMLHttpRequest.setRequestHeader("FIN-HD-WECHAT-TOKEN", getCookie('FIN-HD-WECHAT-TOKEN'));
             },
             dataType: "json",
             success: function(res){
              if (res.code == '000000' && res.data.wxFlag === '0') {
                //请求成功,跳到登录页(前提是不存在已登录未注册的情况)
                console.log(res);
                // this.props.history.replace('/login')
                getWXPayParams();
              } else if (res.code == '000000' && res.data.wxFlag === '3') {
                // 已授权不需要登陆
                setCookie('FIN-HD-WECHAT-TOKEN', res.data.wxToken, 365); // 微信授权token
                setCookie('FIN-HD-AUTH-TOKEN', res.data.tokenId, 365);
                getWXPayParams();
              } else {
                $('#QRPay').html('<img src="/assets/lib/loading_error.png" class="err_img" /><p>'+res.message+'</p>');
              }
            },
            error: function(res){
              //  alert(JSON.stringify(res))
             },
          });
        }

        // 检查微信授权
        function wxCheckAuth(){
          const osName = getDeviceType() === 'IOS' ? '01' : getDeviceType() === 'ANDROID' ? '02' : '';
          $.ajax({
              type: "POST",
              url: "/front/signup/wx/auth",
              data: JSON.stringify({
                redirectUrl: encodeURIComponent(window.location.href),
                osType: getDeviceType().toLowerCase(),
                loginType: '0',
                code: '',
                imei: '',
                location: '-1,-1',
                mac: '',
                registrationId: '',
                state: '111',
                userChannel: ''
              }),
             contentType: "application/json",
             dataType: "json",
             success: function(res){
              if (res.code == '000000' && res.data.wxFlag === '1') {
                //没有授权
                setCookie('FIN-HD-WECHAT-TOKEN', res.data.wxToken, 365);
                window.location.href = decodeURIComponent(res.data.wxUrl);
              } else if (res.code == '000000' && res.data.wxFlag === '2') {
                //已授权未登录 (静默授权为7天，7天后过期）
                // this.props.history.replace('/home/home')
                // this.props.history.replace('/login')
                getWXPayParams();
              } else if (res.code == '000000' && res.data.wxFlag === '3') {
                //已授权已登录
                setCookie('FIN-HD-AUTH-TOKEN', res.data.tokenId, { expires: 365 });
                // localStorage.setItem('authorizedNotLoginStats', 'true')
                getWXPayParams();
              } else {
                $('#QRPay').html('<img src="/assets/lib/loading_error.png" class="err_img" /><p>'+res.message+'</p>');
              }
            }
          });
        }

        // 判断是否有WeixinJSBridge方法
        function wxPay(wxData) {
          if (window.WeixinJSBridge) {
            openWxPay(wxData);
          } else {
            document.addEventListener(
              'WeixinJSBridgeReady',
              () => {
                openWxPay(wxData);
              },
              false
            );
          }
        }
        // 调起微信支付
        function openWxPay(wxData) {
          $('#QRPay').html('');
          window.WeixinJSBridge.invoke(
            'getBrandWCPayRequest',
            {
              appId: wxData.appId,
              timeStamp: wxData.timeStamp,
              nonceStr: wxData.nonceStr,
              package: wxData.package,
              signType: wxData.signType,
              paySign: wxData.paySign
            },
            (result) => {
              if (result.err_msg == 'get_brand_wcpay_request:ok') {
                setTimeout(() => {
                  window.close();
                  window.WeixinJSBridge.call('closeWindow');
                }, 2000);
              } else {
                $('#QRPay').html('支付失败,请点击<a class="reloadBtn" href="javascript:void(0);" onclick="window.location.reload()">重试</a>');
              }
            }
          );
        }

        // 获取微信支付需要的参数
        function getWXPayParams() {
          const reqOrdNo = getUrlParam('reqOrdNo');
          const osName = getDeviceType() === 'IOS' ? '01' : getDeviceType() === 'ANDROID' ? '02' : '';
          $.ajax({
             type: "POST",
             url: "/front/repay/getQrPayUrl",
             data: JSON.stringify({"reqOrdNo": reqOrdNo, "osName": osName}),
             contentType: "application/json",
             dataType: "json",
             beforeSend: function (XMLHttpRequest) {
               XMLHttpRequest.setRequestHeader("FIN-HD-WECHAT-TOKEN", getCookie('FIN-HD-WECHAT-TOKEN'));
             },
             success: function(res){
              if (res.code === '000000') {
					      let wxData = res.data && res.data.phonePayStr && JSON.parse(res.data.phonePayStr);
                wxPay(wxData);
              } else {
                $('#QRPay').html('<img src="/assets/lib/loading_error.png" class="err_img" /><p>'+res.message+'</p>');
              }
            }
          });
        }
      </script>
		</div>
	</body>
</html>
